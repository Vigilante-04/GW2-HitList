<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GW2 Spotter - Hit List</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #111; color: #eee; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #333; padding: 8px; text-align: left; }
    th { background: #222; }
    .status-online { color: #00ff00; font-weight: bold; }
    .status-offline { color: #ff0000; font-weight: bold; }
  </style>
</head>
<body>
  <h1>GW2 Spotter - Hit List</h1>
  <div id="table-container">Loading...</div>

  <script>
    const API_KEY = "F1C9FA66-0F9C-354B-93E7-419A4ADD6182B25D910B-F9AE-40EC-8460-D42AF1C27BB5";
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbyZ1eKMg4m5xmWmmM1W87OzvvXOqKVXhc7CFCEdJ-O3yFyQTki2euB43cQvPj_SeEH3/exec";

    async function fetchHitList() {
      const res = await fetch(SHEET_URL);
      const json = await res.json();
      return json;
    }

    async function fetchAccountInfo() {
      const res = await fetch("https://api.guildwars2.com/v2/account?access_token=" + API_KEY);
      if (!res.ok) return null;
      return await res.json();
    }

    async function fetchWorldLinks() {
      const res = await fetch("https://api.gw2mists.com/links");
      if (!res.ok) return [];
      return await res.json();
    }

    function renderTable(hitList, accountInfo, worldLinks) {
      if (!hitList || hitList.length === 0) {
        document.getElementById("table-container").innerHTML = "<p>No hit list data found.</p>";
        return;
      }

      const homeWorld = accountInfo?.world || "Unknown World";
      const linkedWorld = worldLinks.find(w => w.worlds.includes(homeWorld));

      let html = `<p>Your Home World: <b>${homeWorld}</b> ${linkedWorld ? `(Linked with: ${linkedWorld.worlds.join(", ")})` : ""}</p>`;
      html += "<table><tr><th>Player</th><th>Priority</th><th>Notes</th><th>Status</th><th>Location</th><th>World</th></tr>";

      hitList.forEach(entry => {
        const playerName = entry["Player account (name.####)"];
        const priority = entry["Priority (1-10)"];
        const notes = entry["Notes"];

        html += `
          <tr>
            <td>${playerName || "-"}</td>
            <td>${priority || "-"}</td>
            <td>${notes || ""}</td>
            <td><span class="status-offline">Unknown</span></td>
            <td>-</td>
            <td>${homeWorld}</td>
          </tr>`;
      });

      html += "</table>";
      document.getElementById("table-container").innerHTML = html;
    }

    async function refreshData() {
      try {
        const [hitList, accountInfo, worldLinks] = await Promise.all([
          fetchHitList(),
          fetchAccountInfo(),
          fetchWorldLinks()
        ]);
        renderTable(hitList, accountInfo, worldLinks);
      } catch (err) {
        console.error("Error refreshing data:", err);
        document.getElementById("table-container").innerHTML = "<p>Error loading data.</p>";
      }
    }

    // Refresh every minute
    setInterval(refreshData, 60000);
    refreshData();
  </script>
</body>
</html>
